## Compare Ground Truth vs NSF Predictions (PushT)

This guide explains how to generate side-by-side videos that compare ground-truth PushT rollouts with predictions from the trained neural stochastic flow (NSF) conditioned on DMP parameters.

### What it does
- **Ground truth (left)**: Replays recorded actions from the dataset in `gym_pusht/PushT-v0` and captures rendered frames.
- **Prediction (right)**: Uses the trained NSF to produce one-shot predictions for arbitrary times from the initial state and the same DMP condition. Frames are rendered on a blank 512×512 canvas with:
  - Agent (blue circle)
  - Block (green square) and a short heading line from the predicted orientation (sin, cos)
  - Goal (red crosshair)

Predictions are deterministic for this comparison: the base mean is pushed through the flow (no sampling). Conditions are standardized with the same stats used during training.

### Prerequisites
- A dataset generated by `scripts/generate_random_dmp_dataset.py` with train/validation/test splits under `data/random_dmp_npz/`.
- A trained NSF checkpoint directory (e.g., `models/nsf_affine_dmp`) with:
  - `best.eqx` (or `latest.eqx`)
  - `condition_stats.json` (if condition standardization was enabled during training)
- Dependencies used in training and data generation (JAX, Equinox, Optax, Gymnasium, `gym_pusht`, `imageio`).

### How it works (inputs/outputs)
- Reads the first N test trajectories from `data/random_dmp_npz/test/index.jsonl`.
- For each trajectory:
  - Loads `time` and `phase` arrays and the per-step `info` dicts (`reset_info`, `step_infos`).
  - Constructs the initial state `x(0)` in the 7D space used during training (see `docs/train_nsf_affine_dmp.md`).
  - Constructs the condition vector from trajectory metadata and standardizes it using `condition_stats.json`.
  - Computes predictions for each saved timestamp by evaluating the NSF once from `t_init = 0` to `t_final = t` (non-recursive, one-shot per time).
  - Renders a side-by-side video: left = env-rendered GT frames, right = rendered predictions.

### Usage
```bash
uv run -- python scripts/compare_flow_vs_gt.py \
  --data-root data/random_dmp_npz \
  --test-split test \
  --checkpoint-dir models/nsf_affine_dmp \
  --use-best \
  --num-trajs 10 \
  --output-dir videos/compare_flow_predictions \
  --fps 10
```

### Script location
- `scripts/compare_flow_vs_gt.py`

### Options
- `--data-root`: Root directory of the dataset (default: `data/random_dmp_npz`).
- `--test-split`: Name of the test split directory (default: `test`).
- `--checkpoint-dir`: Directory containing NSF checkpoints and condition stats (required).
- `--use-best`: Load `best.eqx` instead of `latest.eqx`.
- `--num-trajs`: Number of trajectories to render (default: 10).
- `--output-dir`: Directory to write comparison MP4 files (default: `videos/compare_flow_predictions`).
- `--fps`: Frames per second for output videos (default: 10).

### Output
- One MP4 per trajectory (e.g., `compare_000.mp4`, `compare_001.mp4`, …) under `--output-dir`.
- Each video is 512×1024 (two 512×512 panels concatenated horizontally).

### Notes
- Time alignment: the predicted panel skips `t=0` so frames align with environment steps (`len = T`).
- State and condition definitions follow `docs/train_nsf_affine_dmp.md`:
  - State (7D): `[pos_agent_x, pos_agent_y, block_x, block_y, sin(theta), cos(theta), phase]` in normalized coordinates.
  - Condition: DMP hyperparameters + start/goal (normalized) + flattened weight matrix; standardized with train-split stats if available.
- If you used non-default model hyperparameters during training, ensure the script reconstructs the same architecture before deserializing parameters.


