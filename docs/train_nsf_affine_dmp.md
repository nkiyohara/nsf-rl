# Train Autonomous Neural Stochastic Flow (Affine Coupling) on DMP Pairs

This trains an autonomous conditional neural stochastic flow on pairwise transitions sampled from the JSONL-indexed dataset generated by `scripts/generate_random_dmp_dataset.py`.

## State and Condition
- **State (default `--state-source waypoint`, 5D)**: `[dmp_x, dmp_y, dmp_vx, dmp_vy, phase]`
  - Positions and velocities come directly from the normalized DMP rollout sampled at the environment control rate (`[-1, 1]` range). Velocities are normalized by dividing pixel velocities by half-span.
- **State (`--state-source env`, 9D)**: `[pos_agent_x, pos_agent_y, vel_agent_x, vel_agent_y, block_x, block_y, sin(theta), cos(theta), phase]`
  - Pixel-like terms are normalized to `[-1, 1]`. Agent velocities are normalized by half-span. Angle is converted to radians and represented via `sin, cos`.
- **Condition**: `stiffness, damping, dmp_dt, dmp_alpha_s, dmp_n_basis, scale_forcing_by_goal_delta, start_pixels(2), goal_pixels(2), weights(2*n_basis)`
  - `start_pixels`, `goal_pixels` are normalized to `[-1, 1]`. Others can be standardized using train-set stats (default True).
- Time uses saved `time[T+1]` in seconds from the dataset.

## Losses
- Negative log-likelihood (NLL) at `t_final`.
- Symmetric flow losses `1→2` and `2→1` evaluated at data times and at additional sampled times within `(0, t_final]` with small `eps` margins.

## Requirements
- Dataset created by `scripts/generate_random_dmp_dataset.py` including `time` and `phase`.
- JAX, Equinox, Optax. Optional: Weights & Biases for logging.

## Usage
```bash
uv run -- python scripts/train_nsf_affine_dmp.py \
  --data-root data/random_dmp_npz \
  --train-split train \
  --val-split validation \
  --batch-size 256 \
  --epochs 100 \
  --lr 1e-3 \
  --hidden-size 64 --depth 2 \
  --conditioner-hidden-size 64 --conditioner-depth 2 \
  --num-flow-layers 4 \
  --activation tanh \
  --scale-fn tanh_exp \
  --flow-loss-data-weight 0.2 \
  --flow-loss-sampled-weight 0.2 \
  --flow-1-2-weight 1.0 \
  --flow-2-1-weight 1.0 \
  --state-source waypoint \
  --checkpoint-dir models/nsf_affine_dmp \
  --wandb-project NSF-PushT --run-name dmp-nsf-affine
```

Key options:
- `--standardize-condition/--no-standardize-condition` (default: standardize): controls condition normalization using train stats saved to `<checkpoint_dir>/condition_stats.json`.
- `--state-source {waypoint,env}` (default `waypoint`): choose whether to learn from DMP waypoints/velocities or reconstructed environment observations.
- `--checkpoint-interval` (default 50): additionally saves `epoch_XXX.eqx`.

## Checkpoints and Stats
- `<checkpoint_dir>/latest.eqx` and `<checkpoint_dir>/best.eqx` store parameters for flow and auxiliary models.
- Condition stats saved to `<checkpoint_dir>/condition_stats.json` when standardization is enabled.

## Notes
- Pair sampling: choose indices `0 ≤ i < j ≤ T` uniformly per trajectory; `t_middle` is uniformly sampled in `(t_init, t_final)`.
- Sampled-time flow loss clamps times with `eps` to avoid degeneracy at endpoints.
- Implementation lives in `src/nsf_rl/models/*` and `scripts/train_nsf_affine_dmp.py` (standalone training path).
